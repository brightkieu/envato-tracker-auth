<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envato Tracker - OAuth Callback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2rem;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .logo {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            border-radius: 12px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        h1 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 24px;
        }
        
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
        }
        
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .instructions {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }
        
        .code-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        
        button {
            background: #2E86AB;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 1rem;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #1a5f7a;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ET</div>
        <h1>Envato Tracker</h1>
        <div id="status" class="status loading">
            <div class="spinner"></div>
            Processing OAuth callback...
        </div>
        
        <div id="details" style="display: none;">
            <div class="code-display" id="code-display"></div>
            <button onclick="openApp()" id="open-app-btn" disabled>Open Envato Tracker App</button>
        </div>
        
        <div class="instructions">
            <strong>What's happening:</strong><br>
            1. Envato has redirected you here after authorization<br>
            2. We're processing your OAuth code<br>
            3. You'll be redirected back to the mobile app<br>
            4. If automatic redirect fails, use the button above
        </div>
    </div>

    <script>
        // Parse URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                code: urlParams.get('code'),
                error: urlParams.get('error'),
                error_description: urlParams.get('error_description'),
                state: urlParams.get('state')
            };
        }
        
        // Display status
        function setStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
        }
        
        // Show details
        function showDetails(code) {
            const detailsEl = document.getElementById('details');
            const codeEl = document.getElementById('code-display');
            const btnEl = document.getElementById('open-app-btn');
            
            detailsEl.style.display = 'block';
            codeEl.textContent = `Authorization Code: ${code}`;
            btnEl.disabled = false;
        }
        
        // Open mobile app with deep link
        function openApp() {
            const params = getUrlParams();
            let deepLinkUrl = 'com.envatotracker://oauth/callback';
            
            if (params.code) {
                deepLinkUrl += `?code=${encodeURIComponent(params.code)}`;
                if (params.state) {
                    deepLinkUrl += `&state=${encodeURIComponent(params.state)}`;
                }
            } else if (params.error) {
                deepLinkUrl += `?error=${encodeURIComponent(params.error)}`;
                if (params.error_description) {
                    deepLinkUrl += `&error_description=${encodeURIComponent(params.error_description)}`;
                }
            }
            
            console.log('Opening deep link:', deepLinkUrl);
            
            // Try to open the app
            window.location.href = deepLinkUrl;
            
            // Fallback: Show instructions if app doesn't open
            setTimeout(() => {
                setStatus('error', 'App not found. Please make sure Envato Tracker is installed on your device.');
            }, 3000);
        }
        
        // Main processing function
        function processCallback() {
            const params = getUrlParams();
            
            console.log('OAuth callback received:', params);
            
            if (params.error) {
                setStatus('error', `❌ OAuth Error: ${params.error_description || params.error}`);
                return;
            }
            
            if (!params.code) {
                setStatus('error', '❌ No authorization code received');
                return;
            }
            
            // Success
            setStatus('success', '✅ Authorization successful! Redirecting to app...');
            showDetails(params.code);
            
            // Auto redirect after 2 seconds
            setTimeout(() => {
                openApp();
            }, 2000);
        }
        
        // Run when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add some delay to show the loading state
            setTimeout(processCallback, 1000);
        });
        
        // Manual redirect button
        window.openApp = openApp;
    </script>
</body>
</html>
